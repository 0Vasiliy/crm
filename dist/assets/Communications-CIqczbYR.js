import{f as j,g as E,h as V,i as C,Q as k,e as q}from"./QTabPanels-7m-2RM3o.js";import{P as F,g as u,y as x,x as y,z as p,D as N,B as M,C as H,A as J,_ as K,b as O,d as s,h as L,e as l,w as m,n as W,t as X,o as Y,f as P,a4 as Q,a5 as R,a6 as _,a8 as S}from"./index-94aisbhc.js";import{Q as Z}from"./QTd-C1SIy4o_.js";const $=F("communications",()=>{const r=u([]),o=u([]),d=u([]),e=u(!1),i=u(null);return{notifications:r,templates:o,scenarios:d,loading:e,error:i,fetchNotifications:async()=>{e.value=!0;try{const t=await x(y(p,"notifications"));r.value=t.docs.map(a=>({id:a.id,...a.data()}))}catch(t){i.value=t.message,console.error("Ошибка при загрузке уведомлений:",t)}finally{e.value=!1}},sendNotification:async t=>{try{const c={id:(await N(y(p,"notifications"),{...t,status:"sent",createdAt:new Date().toISOString()})).id,...t};return r.value.push(c),c}catch(a){throw i.value=a.message,console.error("Ошибка при отправке уведомления:",a),a}},fetchTemplates:async()=>{e.value=!0;try{const t=await x(y(p,"messageTemplates"));o.value=t.docs.map(a=>({id:a.id,...a.data()}))}catch(t){i.value=t.message,console.error("Ошибка при загрузке шаблонов:",t)}finally{e.value=!1}},createTemplate:async t=>{try{const c={id:(await N(y(p,"messageTemplates"),{...t,createdAt:new Date().toISOString()})).id,...t};return o.value.push(c),c}catch(a){throw i.value=a.message,console.error("Ошибка при создании шаблона:",a),a}},fetchScenarios:async()=>{e.value=!0;try{const t=await x(y(p,"chatbotScenarios"));d.value=t.docs.map(a=>({id:a.id,...a.data()}))}catch(t){i.value=t.message,console.error("Ошибка при загрузке сценариев:",t)}finally{e.value=!1}},addScenario:async t=>{try{const c={id:(await N(y(p,"chatbotScenarios"),{...t,createdAt:new Date().toISOString()})).id,...t};return d.value.push(c),c}catch(a){throw i.value=a.message,console.error("Ошибка при добавлении сценария:",a),a}},updateScenario:async(t,a)=>{try{const c=M(p,"chatbotScenarios",t);await H(c,{...a,updatedAt:new Date().toISOString()});const h=d.value.findIndex(T=>T.id===t);h!==-1&&(d.value[h]={...d.value[h],...a})}catch(c){throw i.value=c.message,console.error("Ошибка при обновлении сценария:",c),c}},deleteScenario:async t=>{try{await J(M(p,"chatbotScenarios",t)),d.value=d.value.filter(a=>a.id!==t)}catch(a){throw i.value=a.message,console.error("Ошибка при удалении сценария:",a),a}}}}),ee={name:"CommunicationsModule",setup(){const r=$(),o=u("notifications"),d=u(!1),e=u({show:!1,message:"",type:""}),i=u(null),b=u([]),n=u(""),v=u({question:"",answer:""}),w=u({name:"",type:"",content:""}),U=[{name:"id",label:"ID",field:"id",sortable:!0},{name:"template",label:"Шаблон",field:"template",sortable:!0},{name:"recipients",label:"Получатели",field:"recipients",sortable:!0},{name:"status",label:"Статус",field:"status",sortable:!0},{name:"createdAt",label:"Дата отправки",field:"createdAt",sortable:!0}],D=[{name:"question",label:"Вопрос",field:"question",sortable:!0},{name:"answer",label:"Ответ",field:"answer",sortable:!0},{name:"actions",label:"Действия",field:"actions",align:"center"}],I=[{name:"name",label:"Название",field:"name",sortable:!0},{name:"type",label:"Тип",field:"type",sortable:!0},{name:"content",label:"Содержание",field:"content",sortable:!0}],A=[{label:"Все жильцы",value:"all"},{label:"Должники",value:"debtors"},{label:"Новые жильцы",value:"new"}],t=[{label:"Уведомление",value:"notification"},{label:"Напоминание",value:"reminder"},{label:"Информационное",value:"info"}],a=(f,g="success")=>{e.value={show:!0,message:f,type:g},setTimeout(()=>{e.value.show=!1},3e3)},c=async()=>{var f,g;if(!i.value&&!n.value){a("Пожалуйста, выберите шаблон или введите текст сообщения","error");return}if(!b.value.length){a("Пожалуйста, выберите получателей","error");return}try{const B={template:((f=i.value)==null?void 0:f.name)||"Пользовательский шаблон",message:((g=i.value)==null?void 0:g.content)||n.value,recipients:b.value,status:"pending"};await r.sendNotification(B),a("Уведомление успешно отправлено"),i.value=null,b.value=[],n.value=""}catch{a("Ошибка при отправке уведомления","error")}},h=async()=>{if(!w.value.name||!w.value.type||!w.value.content){a("Пожалуйста, заполните все поля шаблона","error");return}try{await r.createTemplate(w.value),a("Шаблон успешно создан"),w.value={name:"",type:"",content:""}}catch{a("Ошибка при создании шаблона","error")}},T=async()=>{if(!v.value.question||!v.value.answer){a("Пожалуйста, заполните вопрос и ответ","error");return}try{await r.addScenario(v.value),a("Сценарий успешно добавлен"),v.value={question:"",answer:""}}catch{a("Ошибка при добавлении сценария","error")}},z=f=>{v.value={...f}},G=async f=>{try{await r.deleteScenario(f.id),a("Сценарий успешно удален")}catch{a("Ошибка при удалении сценария","error")}};return Y(async()=>{d.value=!0;try{await Promise.all([r.fetchNotifications(),r.fetchTemplates(),r.fetchScenarios()])}catch{a("Ошибка при загрузке данных","error")}finally{d.value=!1}}),{activeTab:o,loading:d,notification:e,selectedTemplate:i,selectedRecipients:b,notificationMessage:n,newScenario:v,newTemplate:w,notifications:r.notifications,templates:r.templates,scenarios:r.scenarios,notificationColumns:U,scenarioColumns:D,templateColumns:I,recipientGroups:A,templateTypes:t,sendNotification:c,createTemplate:h,addScenario:T,editScenario:z,deleteScenario:G}}},ae={class:"communications-module"},oe={class:"communications-tabs"},te={class:"row q-col-gutter-md"},le={class:"col-12"},ne={class:"row q-col-gutter-md"},se={class:"col-12 col-md-6"},ie={class:"col-12 col-md-6"},ce={class:"col-12"},re={class:"col-12"},de={class:"row q-col-gutter-md"},me={class:"col-12"},ue={class:"row q-col-gutter-md"},fe={class:"col-12 col-md-4"},ve={class:"col-12 col-md-8"},pe={class:"col-12"},we={class:"row q-col-gutter-md"},be={class:"col-12"},ye={class:"row q-col-gutter-md"},he={class:"col-12 col-md-6"},ge={class:"col-12 col-md-6"},_e={class:"col-12"},Se={class:"col-12"};function Te(r,o,d,e,i,b){return P(),O("div",ae,[o[13]||(o[13]=s("h1",null,"Коммуникации",-1)),s("div",oe,[l(j,{modelValue:e.activeTab,"onUpdate:modelValue":o[0]||(o[0]=n=>e.activeTab=n),class:"text-primary","active-color":"primary","indicator-color":"primary",align:"justify"},{default:m(()=>[l(V,{name:"notifications",label:"Массовые рассылки"}),l(V,{name:"chatbot",label:"Чат-бот"}),l(V,{name:"templates",label:"Шаблоны"})]),_:1},8,["modelValue"]),l(E,{modelValue:e.activeTab,"onUpdate:modelValue":o[9]||(o[9]=n=>e.activeTab=n),animated:""},{default:m(()=>[l(C,{name:"notifications"},{default:m(()=>[s("div",te,[s("div",le,[l(Q,null,{default:m(()=>[l(R,null,{default:m(()=>[o[10]||(o[10]=s("div",{class:"text-h6"},"Отправка уведомлений",-1)),s("div",ne,[s("div",se,[l(k,{modelValue:e.selectedTemplate,"onUpdate:modelValue":o[1]||(o[1]=n=>e.selectedTemplate=n),options:e.templates,label:"Шаблон сообщения","option-label":"name"},null,8,["modelValue","options"])]),s("div",ie,[l(k,{modelValue:e.selectedRecipients,"onUpdate:modelValue":o[2]||(o[2]=n=>e.selectedRecipients=n),options:e.recipientGroups,label:"Группа получателей",multiple:""},null,8,["modelValue","options"])]),s("div",ce,[l(_,{modelValue:e.notificationMessage,"onUpdate:modelValue":o[3]||(o[3]=n=>e.notificationMessage=n),type:"textarea",label:"Текст сообщения",disable:!!e.selectedTemplate},null,8,["modelValue","disable"])]),s("div",re,[l(S,{color:"primary",label:"Отправить",onClick:e.sendNotification},null,8,["onClick"])])]),l(q,{rows:e.notifications,columns:e.notificationColumns,"row-key":"id",loading:e.loading},null,8,["rows","columns","loading"])]),_:1,__:[10]})]),_:1})])])]),_:1}),l(C,{name:"chatbot"},{default:m(()=>[s("div",de,[s("div",me,[l(Q,null,{default:m(()=>[l(R,null,{default:m(()=>[o[11]||(o[11]=s("div",{class:"text-h6"},"Настройка чат-бота",-1)),s("div",ue,[s("div",fe,[l(_,{modelValue:e.newScenario.question,"onUpdate:modelValue":o[4]||(o[4]=n=>e.newScenario.question=n),label:"Вопрос"},null,8,["modelValue"])]),s("div",ve,[l(_,{modelValue:e.newScenario.answer,"onUpdate:modelValue":o[5]||(o[5]=n=>e.newScenario.answer=n),type:"textarea",label:"Ответ"},null,8,["modelValue"])]),s("div",pe,[l(S,{color:"primary",label:"Добавить сценарий",onClick:e.addScenario},null,8,["onClick"])])]),l(q,{rows:e.scenarios,columns:e.scenarioColumns,"row-key":"id",loading:e.loading},{"body-cell-actions":m(n=>[l(Z,{props:n},{default:m(()=>[l(S,{flat:"",color:"primary",icon:"edit",onClick:v=>e.editScenario(n.row)},null,8,["onClick"]),l(S,{flat:"",color:"negative",icon:"delete",onClick:v=>e.deleteScenario(n.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading"])]),_:1,__:[11]})]),_:1})])])]),_:1}),l(C,{name:"templates"},{default:m(()=>[s("div",we,[s("div",be,[l(Q,null,{default:m(()=>[l(R,null,{default:m(()=>[o[12]||(o[12]=s("div",{class:"text-h6"},"Шаблоны сообщений",-1)),s("div",ye,[s("div",he,[l(_,{modelValue:e.newTemplate.name,"onUpdate:modelValue":o[6]||(o[6]=n=>e.newTemplate.name=n),label:"Название шаблона"},null,8,["modelValue"])]),s("div",ge,[l(k,{modelValue:e.newTemplate.type,"onUpdate:modelValue":o[7]||(o[7]=n=>e.newTemplate.type=n),options:e.templateTypes,label:"Тип шаблона"},null,8,["modelValue","options"])]),s("div",_e,[l(_,{modelValue:e.newTemplate.content,"onUpdate:modelValue":o[8]||(o[8]=n=>e.newTemplate.content=n),type:"textarea",label:"Содержание"},null,8,["modelValue"])]),s("div",Se,[l(S,{color:"primary",label:"Создать шаблон",onClick:e.createTemplate},null,8,["onClick"])])]),l(q,{rows:e.templates,columns:e.templateColumns,"row-key":"id",loading:e.loading},null,8,["rows","columns","loading"])]),_:1,__:[12]})]),_:1})])])]),_:1})]),_:1},8,["modelValue"])]),e.notification.show?(P(),O("div",{key:0,class:W(["notification",e.notification.type])},X(e.notification.message),3)):L("",!0)])}const qe=K(ee,[["render",Te],["__scopeId","data-v-78cd613b"]]);export{qe as default};
